/*
 * @title WET-BOEW Geomap
 * @overview Displays a dynamic map over which information from additional sources can be overlaid.
 * @license wet-boew.github.io/wet-boew/License-en.html / wet-boew.github.io/wet-boew/Licence-fr.html
 * @author @pjackson28
 */
!function(a,b,c,d){"use strict";var e,f,g,h,i="wb-geomap",j="."+i,k=d.doc,l=2e3,m=0,n=[],o={overlays:[],features:[],tables:[],useScaleLine:!1,useMousePosition:!1,useLegend:!1,useTab:!1,useMapControls:!0,useGeocoder:!1,useGeolocation:!1,useAOI:!1},p={GREATER_THAN:">",LESS_THAN:"<",EQUAL_TO:"="},q=function(e){var j,k,l=e.target,m=l.className,n={};e.currentTarget===l&&(j=a(l),h||(g=d.i18n,h={add:g("add"),close:g("close"),colon:g("colon"),hiddenLayer:g("geo-hdnlyr"),toggleLayer:g("geo-tgllyr"),labelSelect:g("geo-lblsel"),select:g("geo-sel"),zoomFeature:g("geo-zmfeat"),zoomin:g("geo-zmin"),zoomout:g("geo-zmout"),zoomworld:g("geo-zmwrld"),baseMapTitle:g("geo-bmapttl"),baseMapURL:g("geo-bmapurl"),baseMapURLTxt:g("geo-bmapurltxt"),scaleline:g("geo-sclln"),mouseposition:g("geo-msepos"),access:g("geo-ally"),accessTitle:g("geo-allyttl"),attribLink:g("geo-attrlnk"),attribTitle:g("geo-attrttl"),ariaMap:g("geo-ariamap"),geoLocationURL:g("geo-locurl-geogratis"),geoCoderPlaceholder:g("geo-loc-placeholder"),geoCoderLabel:g("geo-loc-label"),aoiNorth:g("geo-aoi-north"),aoiEast:g("geo-aoi-east"),aoiSouth:g("geo-aoi-south"),aoiWest:g("geo-aoi-west"),aoiInstructions:g("geo-aoi-instructions"),aoiBtnDraw:g("geo-aoi-btndraw"),aoiBtnClear:g("geo-aoi-btnclear"),aoiBtnClose:g("close"),geolocBtn:g("geo-geoloc-btn"),geolocFail:g("geo-geoloc-fail"),geolocUncapable:g("geo-geoloc-uncapable"),geoLgndGrphc:g("geo-lgnd-grphc")}),k={useScaleLine:-1!==m.indexOf("scaleline")?!0:void 0,useMousePosition:-1!==m.indexOf("position")?!0:void 0,useLegend:-1!==m.indexOf("legend"),useTab:-1!==m.indexOf("tab"),useMapControls:-1!==m.indexOf("static")?!1:!0,useGeocoder:-1!==m.indexOf("geocoder")?!0:!1,useGeolocation:-1!==m.indexOf("geolocation")?!0:!1,useAOI:-1!==m.indexOf("aoi")?!0:!1},a.extend(n,o,k,b[i],d.getData(j,i)),j.data({settings:n}),b.Proj4js={Proj:function(a){var c=proj4(b.Proj4js.defs[a]);return c.srsCode=a,c},defs:proj4.defs,transform:proj4},OpenLayers.Lang.setCode(c.documentElement.lang),OpenLayers.ImgPath=d.getPath("/assets")+"/",proj4.defs("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"),f=r(j),f.aoiToggle="undefined"!=typeof n.aoi&&"undefined"!=typeof n.aoi.toggle?n.aoi.toggle:!0,f.aoiExtent="undefined"!=typeof n.aoi&&"undefined"!=typeof n.aoi.extent?n.aoi.extent:null,n.layersFile?a.ajax({url:n.layersFile,dataType:"script",async:!1,success:function(){a.extend(n,wet_boew_geomap),W(f,n)}}):W(f,n),f.overlays||da(f))},r=function(a){var b={mapid:a.attr("id"),map:null,selectControl:null,showAttribNRCan:!1,queryLayers:[],overlays:0,overlaysLoaded:0,overlaysLoading:{}},c=a.find(".wb-geomap-map");return b.gmap=c.attr("id","geomap-map-"+b.mapid).height(.8*c.width()),b.glegend=a.find(".wb-geomap-legend").attr("id","geomap-legend-"+b.mapid),b.glayers=a.find(".wb-geomap-layers").attr("id","geomap-layers-"+b.mapid),b},s=function(a){var b=new OpenLayers.Control.PanZoom;OpenLayers.Util.extend(b,{draw:function(){var a,b=this,c=["zoomin","zoomout","zoomworld"],d=["zoom-plus-mini","zoom-minus-mini","zoom-world-mini"],e=c.length;for(OpenLayers.Control.prototype.draw.apply(b,arguments),b.buttons=[],a=0;a!==e;a+=1)b._addButton(c[a],d[a]+".png");return b.div}}),a.map.addControl(b),t(a)},t=function(a){var b,c,d,e,f,g=a.gmap.find(".olControlPanZoom")[0],i=g.getElementsByTagName("div"),j=i.length;for(g.setAttribute("role","toolbar"),b=0;b!==j;b+=1)c=i[b],d=c.getElementsByTagName("img")[0],d&&(f=c.action,e=h[f],c.setAttribute("aria-label",e),c.setAttribute("title",e),c.setAttribute("role","button"),c.className+=" olControl"+f,c.tabIndex=0,d.setAttribute("alt",e),d.className+=" olControl"+f)},u=function(b){var c=b.id.replace(/\W/g,"_");a("#"+c).addClass("active"),a("#cb_"+c).prop("checked",!0)},v=function(b){var c=b.id.replace(/\W/g,"_"),d=b.popup;a("#"+c).removeClass("active"),a("#cb_"+c).prop("checked",!1),d&&d.visible()&&d.hide()},w=function(a){var b=a.layer.map.getControlsByClass("OpenLayers.Control.SelectFeature")[0];a._lastHighlighter?b.unselect(a):(b.select(a),a.layer.popups&&(e&&e.popup&&e.popup.visible()&&e.popup.hide(),a.popup?a.popup.toggle():x(a)))},x=function(a){var b,d,e,g,i,j,k,l,m,n,o,p=a.layer.popupsInfo,q=a.id.replace(/\W/g,"_"),r=h.close,s=h.colon,t=a.layer.map.size,u="<h3>"+c.getElementById(a.layer.name).getAttribute("aria-label")+"</h3>";if(p){m=p.id,n=p.width,o=p.height,b=(m?m:"popup_")+"_"+q,d=o?o:t.h/2,e=n?n:t.w/2,g=n?p.close:!0,u+=p.content;for(i in a.attributes)a.attributes.hasOwnProperty(i)&&0!==i.length&&(l=new RegExp("_"+i,"igm"),u=u.replace(l,a.attributes[i]))}else{b="popup_"+q,d=t.h/2,e=t.w/2,g=!0;for(i in a.attributes)a.attributes.hasOwnProperty(i)&&0!==i.length&&(u+="<p><strong>"+i+s+"</strong><br />"+a.attributes[i]+"</p>")}j=new OpenLayers.Popup.FramedCloud(b,a.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(e,d),u,null,g,null),j.maxSize=new OpenLayers.Size(e,d),a.popup=j,a.layer.map.addPopup(j),k=c.createElement("span"),k.className="glyphicon glyphicon-remove-circle close_"+q,k.setAttribute("data-map",f.mapid),k.setAttribute("data-layer",a.layer.id),k.setAttribute("data-feature",a.id),k.setAttribute("aria-label",r),k.setAttribute("title",r),k.setAttribute("role","button"),k.setAttribute("tabindex","0"),a.popup.closeDiv.appendChild(k)},y=function(a,b){if(b){var c=a.glayers.find(".wb-geomap-tabs");0!==c.length?c.attr({"class":"wb-tabs auto-height-none",id:"geomap-tabs-"+a.mapid}):a.glayers.prepend("<div id='geomap-tabs-"+a.mapid+"' class='wb-geomap-tabs wb-tabs auto-height-none' style='width: "+a.glayers.width()+"px;'>")}},z=function(b,c,d,e){return a("<table class='table "+(e?" wb-tables":" table-condensed")+"' aria-label='"+c+"' id='overlay_"+b+"'><caption>"+d+"</caption><thead></thead><tbody></tbody></table>")},A=function(b,c,d,e,f){0!==b.glegend.length&&B(b,c,d,e);var g=b.glayers,i=a("<div class='wb-geomap-table-wrapper'></div>"),j=c[0].id,k=a("<div id='tabs_"+j+"'>"),l=c[0].attributes["aria-label"].value,m=a("<h3>"+l+"</h3>"),n=a("<div id='msg_"+j+"'><p>"+h.hiddenLayer+"</p></div>");f&&0!==a(".wb-geomap-tabs").length?F(b,c,d,e):(k.append(m,i.append(c)),g.append("<div class='col-md-12'>"+k.html()+"</div>")),d||(k.append(n),i.hide())},B=function(b,c,d,e){var f,g,i,j,k,l,m=a(c),n=c[0].id,o=b.glegend;b.glegend&&(f=o.find("fieldset"),0===f.length&&(f=o.append("<fieldset name='legend'><legend class='wb-inv'>"+h.toggleLayer+"</legend></fieldset>")),i=d?"checked='checked'":"",g=o.find("ul"),0===g.length&&(g=a("<ul class='list-unstyled'></ul>").appendTo(f)),j=a("<input type='checkbox' id='cb_"+n+"' class='geomap-lgnd-cbx' value='"+n+"' "+i+" data-map='"+b.mapid+"' data-layer='"+e+"' />"),k=a("<label>",{"for":"cb_"+n,text:m.attr("aria-label")}).prepend(j),l=a("<li class='checkbox geomap-lgnd-layer'>").append(k,"<div id='sb_"+n+"'></div>"),g.append(l),a("#sb_"+n).toggle(d))},C=function(b){var c,d,e,f,g,i,j,k,l,m,n,o,p,q=b.map.layers.length,r=[];for(m=0;m!==q;m+=1)if(g=b.map.layers[m],g.isBaseLayer||"OpenLayers.Layer.WMS"===g.CLASS_NAME)"OpenLayers.Layer.WMS"===g.CLASS_NAME&&(g.legendUrl?a("#sb_"+g.name).append("<img src='"+g.legendUrl+"' alt='"+h.geoLgndGrphc+"'/>"):g.legendHTML&&a("#sb_"+g.name).append(g.legendHTML));else if(d=a("#sb_"+g.name),d.length)if(i=g.styleMap.styles["default"],j=i.defaultStyle,c=i.rules.length){for(e="<ul class='list-unstyled'>",n=0;n!==c;n+=1)o=i.rules[n],k=o.filter,l=o.symbolizer,p="ls_"+g.name+"_"+n,f=o.title?o.title:l.name?l.name:k.value,e+="<li><div class='row'><div id='"+p+"' class='col-md-2 geomap-legend-symbol'></div><div class='col-md-10'><small>"+f+"</small></div></div></li>",r.push({id:p,feature:g.features[0],symbolizer:l});d.append(e)}else r.push({id:"sb_"+g.name,feature:g.features[0],symbolizer:j});D(r)},D=function(a){var b,c,d=a.length;for(b=0,d;b!==d;b+=1)c=a[b],E(c.id,c.feature,c.symbolizer)},E=function(a,b,c){var d,e,f,g,h,i=b&&b.geometry?b.geometry.CLASS_NAME:"OpenLayers.Geometry.Polygon",j=20,k=c.strokeWidth?c.strokeWidth:0,l=["SVG","VML","Canvas"],m=20;for(g=0,h=l.length;g!==h;g+=1)if(e=OpenLayers.Renderer[l[g]],e&&e.prototype.supported()){f=new e(a,null);break}switch(f.map={resolution:1,getResolution:function(){return this.resolution}},i){case"OpenLayers.Geometry.Polygon":d=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(2,2),new OpenLayers.Geometry.Point(2,18),new OpenLayers.Geometry.Point(18,18),new OpenLayers.Geometry.Point(18,2),new OpenLayers.Geometry.Point(2,2)])]));break;case"OpenLayers.Geometry.Point":j=c.graphicHeight?c.graphicHeight:c.pointRadius?2*c.pointRadius+2*k:20,m=c.graphicWidth?c.graphicWidth:c.pointRadius?2*c.pointRadius+2*k:20,d=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(m/2,j/2));break;case"OpenLayers.Geometry.LineString":d=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(2,18),new OpenLayers.Geometry.Point(6,2),new OpenLayers.Geometry.Point(12,18),new OpenLayers.Geometry.Point(18,2)]));break;default:d=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(2,2),new OpenLayers.Geometry.Point(2,18),new OpenLayers.Geometry.Point(18,18),new OpenLayers.Geometry.Point(18,2),new OpenLayers.Geometry.Point(2,2)])]))}f.setSize(new OpenLayers.Size(m,j)),f.resolution=1,f.setExtent(new OpenLayers.Bounds(0,0,m,j),!0),f.clear(),f.drawFeature(d,c)},F=function(b,c,d){var e,f=b.glayers.find(".wb-geomap-tabs"),g=f.find("ul"),i=c[0].id,j=a("<div class='wb-geomap-table-wrapper'></div>").append(c),k=c.attr("aria-label");e=a("<details>",{id:"details-"+i}).append("<summary>"+k+"</summary>",j),g.append("<li><a href='#tabs_"+i+"'>"+k+"</a></li>"),f.append(e),d||(e.append("<div id='msg_"+i+"'><p>"+h.hiddenLayer+"</p></div>"),j.hide())},G=function(a){var b,c,e,f,g,h,i,j,k,l,n,o,p,q,r,s=d.drawColours[m],t=s,u={strokeColor:s,fillColor:t,fillOpacity:.5,pointRadius:5,strokeWidth:.5},v={strokeColor:"#00f",fillColor:"#00f",fillOpacity:.4,strokeWidth:2},w=a.style;if(m+=1,m===d.drawColours.length&&(m=0),w)if(k=w.type,o=w.select,l={select:new OpenLayers.Style(o?o:v)},"rule"===k){for(c=[],j=new OpenLayers.Style,n=w.rule,h=n.length,f=0;f!==h;f+=1)if(e=n[f],p=e.filter,"AND"===p||"OR"===p||"NOT"===p){for(r=[],i=e.filters.length,g=0;g!==i;g+=1)q=e.filters[g],r.push(H(q));c.push(new OpenLayers.Rule({filter:new OpenLayers.Filter.Logical({title:e.title,type:OpenLayers.Filter.Logical[p],filters:r}),symbolizer:e.init}))}else e.elseFilter===!0?c.push(new OpenLayers.Rule({title:e.title,elseFilter:!0,symbolizer:e.init})):c.push(H(e));j.addRules(c),l["default"]=j}else"unique"!==k&&(l["default"]=new OpenLayers.Style(w.init));else l={"default":new OpenLayers.Style(u),select:new OpenLayers.Style(v)};return b=new OpenLayers.StyleMap(l),w&&"unique"===k&&b.addUniqueValueRules("default",w.field,w.init),b},H=function(a){var b={type:OpenLayers.Filter.Comparison[a.filter],property:a.field,symbolizer:a.init};switch(a.filter){case"BETWEEN":b.lowerBoundary=a.value[0],b.upperBoundary=a.value[1],b.title="undefined"==typeof a.title?a.field+" "+a.value[0]+"-"+a.value[1]:a.title;break;default:b.value=a.value[0],b.title="undefined"==typeof a.title?a.field+" "+p[a.filter]+" "+a.value:a.title}return new OpenLayers.Filter.Comparison(b)},I=function(a,b,c,d){var e,f,g=b.feature,i=g.attributes,j="head"===b.type,k=g.id.replace(/\W/g,"_");e=j?"<tr><th>"+h.select+"</th>":"<tr id='featureId'>"+M(a,g,k);for(f in i)i.hasOwnProperty(f)&&(e+=j?"<th>"+f+"</th>":"<td>"+i[f]+"</td>");return c&&(j?d&&(e+="<th>"+h.zoomFeature+"</th>"):e+=N(a,b.feature)),e+"</tr>"},J=function(b,e,f,g,h,i){var j,k,l={type:"head",feature:f.features[0]},m=c.getElementById(e.attr("id")),n=m.getElementsByTagName("thead")[0],o=m.getElementsByTagName("tbody")[0],p=b.selectControl,q=f.features,r=q.length,s=/\W/g,t=I(b,l,g,i),u=o.innerHTML;for(k=0;k!==r;k+=1)j=q[k],u+=I(b,{type:"body",id:j.id.replace(s,"_"),feature:j,selectControl:p},g,i);d.ielt9?(a(n).html(t),a(o).html(u)):(a(n).html(t),a(o).html(u))},K=function(a){a.gmap.find(".olTileImage").attr("alt",""),a.overlaysLoaded+=1,a.overlays===a.overlaysLoaded&&(da(a),a.overlays=0,a.overlaysLoaded=0)},L=function(b,e,f,g){var h=e.id.replace(/\W/g,"_"),i=c.getElementById(h),j=M(b,e,h)+i.innerHTML+(g&&f?N(b,e):"");d.ielt9?a(i).html(j):a(i).html(j)},M=function(a,b,c){return"<td><label class='wb-inv' for='cb_"+c+"'>"+h.labelSelect+"</label><input type='checkbox' id='cb_"+c+"' class='geomap-cbx' data-map='"+a.mapid+"' data-layer='"+b.layer.id+"' data-feature='"+b.id+"' /></td>"},N=function(a,b){return"<td><a href='javascript:;' data-map='"+a.mapid+"' data-layer='"+b.layer.id+"' data-feature='"+b.id+"' class='btn btn-default btn-sm geomap-zoomto'>"+h.zoomFeature+"</a></td>"},O=function(a){var b,c=a.gmap.width(),d={name:h.baseMapTitle,url:h.baseMapURL,layer:h.baseMapTitle,matrixSet:"nativeTileMatrixSet",tileSize:new OpenLayers.Size(256,256),format:"image/jpg",style:"default",requestEncoding:"REST",isBaseLayer:!0,isSingleTile:!1,tileOrigin:new OpenLayers.LonLat(-34655800,3931e4),zoomOffset:5,resolutions:[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215],transitionEffect:"resize"};for(c>260&&500>=c?d.zoomOffset=1:c>500&&725>=c?d.zoomOffset=2:c>725&&1175>=c?d.zoomOffset=3:c>1175&&2300>=c&&(d.zoomOffset=4),b=d.zoomOffset-1;-1!==b;b-=1)d.resolutions.shift();a.map.addLayer(new OpenLayers.Layer.WMTS(d)),d.url=h.baseMapURLTxt,d.isBaseLayer=!1,delete d.transitionEffect,a.map.addLayer(new OpenLayers.Layer.WMTS(d))},P=function(){var a={maxExtent:new OpenLayers.Bounds(-275e4,-9e5,36e5,463e4),restrictedExtent:new OpenLayers.Bounds(-285e4,-1e6,37e5,473e4),maxResolution:"auto",projection:"EPSG:3978",units:"m",displayProjection:new OpenLayers.Projection("EPSG:4269"),aspectRatio:.8,fractionalZoom:!1,tileManager:null};return a},Q=function(b,c){var d,e,f,g,h,i,j=c.basemap,k=j&&0!==j.length,l={},m=c.useMapControls?[new OpenLayers.Control.Navigation({zoomWheelEnabled:!0})]:[];if(k)if(f=j.mapOptions)try{i=f;for(h in i)i.hasOwnProperty(h)&&i[h]&&("projection"===h||"displayProjection"===h?l[h]=new OpenLayers.Projection(i[h]):"maxExtent"===h||"restrictedExtent"===h?l[h]=new OpenLayers.Bounds(i[h].split(",")):l[h]=i[h]);l.tileManager=null,e=l}catch(n){e={projection:new OpenLayers.Projection("EPSG:4326")}}else e={projection:new OpenLayers.Projection("EPSG:4326")};else e=P();b.gmap.height(b.gmap.width()*e.aspectRatio),b.map=new OpenLayers.Map(b.gmap.attr("id"),a.extend(c.config,e,{theme:null,controls:m})),k?(g=R(j),d=g.options?g.options:{},d.isBaseLayer=!0,"wms"===j.type?b.map.addLayer(new OpenLayers.Layer.WMS(j.title,j.url,g,d)):"esri"===j.type?b.map.addLayer(new OpenLayers.Layer.ArcGIS93Rest(j.title,j.url,g,d)):"xyz"===j.type&&b.map.addLayer(new OpenLayers.Layer.XYZ(j.title,j.url,g,d))):(O(b),b.showAttribNRCan=!0)},R=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&"type"!==b&&"caption"!==b&&"url"!==b&&"title"!==b&&(c[b]=a[b]);return c},S=function(c,e){var f,g=e.overlays,h=g.length;0!==h&&(c.overlays=h,a.each(g,function(h,i){var j,k=i.type,m=i.title,n=i.visible,o=i.url,p=z(h,m,i.caption,i.datatable);"wms"===k?(j=R(i),f=new OpenLayers.Layer.WMS(m,o,j,i.options),f.name="overlay_"+h,f.datatable=!1,f.popupsInfo=!1,f.popups=!1,f.legendUrl=i.options?i.options.legendGraphicUrl:null,f.legendHTML=i.options?i.options.legendHTML:null,c.map.addLayer(f),B(c,p,n,f.id),f.visibility=n):"kml"===k?(f=new OpenLayers.Layer.Vector(m,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:o,format:new OpenLayers.Format.KML({extractStyles:!i.style,extractAttributes:!0,internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(c){var e,f,g,h,j,k,l,m,n,o=0,p=[],q=i.attributes;for("string"==typeof c&&(d.ie?(l=new b.ActiveXObject("Microsoft.XMLDOM"),l.async=!1,l.loadXML(c),c=l):c=(new DOMParser).parseFromString(c,"text/xml")),e=this.getElementsByTagNameNS(c,"*","Placemark"),h=e.length;o!==h;o+=1){f=e[o],g=a(f),j=new OpenLayers.Feature.Vector,j.geometry=this.parseFeature(f).geometry,k={};for(m in q)q.hasOwnProperty(m)&&(n=g.find(m).text(),k[q[m]]=n?n:g.find("[ name='"+m+"']").text());j.attributes=k,p.push(j)}return p}})}),eventListeners:{featuresadded:function(a){J(c,p,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[m]&&K(c)},loadstart:function(){c.overlaysLoading[m]=!0,setTimeout(function(){c.overlaysLoading[m]&&K(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,p,n,f.id,i.tab),f.visibility=n):"atom"===k?(f=new OpenLayers.Layer.Vector(m,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:o,format:new OpenLayers.Format.Atom({read:function(b){var d,e,f,g,h,j,k,l,m,n,o,p,q,r=this.getElementsByTagNameNS(b,"*","entry"),s=[],t=i.attributes,u=new OpenLayers.Projection("EPSG:4326"),v=c.map.getProjectionObject();for(f=0,g=r.length;f!==g;f+=1){d=r[f],e=a(d),q=this.parseFeature(d),h=new OpenLayers.Feature.Vector,o=q.geometry.components[0],"OpenLayers.Geometry.Polygon"===q.geometry.CLASS_NAME&&5===o.components.length?(k=V(o.components[1].x,o.components[1].y,o.components[3].x,o.components[3].y),l=new OpenLayers.Geometry.LinearRing(k),m=new OpenLayers.Geometry.Polygon(l),n=m.transform(u,v),h.geometry=n):h.geometry=this.parseFeature(d).geometry.transform(u,v),j={};for(p in t)t.hasOwnProperty(p)&&(j[t[p]]=e.find(p).text());h.attributes=j,s.push(h)}return s}})}),eventListeners:{featuresadded:function(a){J(c,p,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[m]&&K(c)},loadstart:function(){c.overlaysLoading[m]=!0,setTimeout(function(){c.overlaysLoading[m]&&K(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,p,n,f.id,i.tab),f.visibility=n):"georss"===k?(f=new OpenLayers.Layer.Vector(m,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:o,format:new OpenLayers.Format.GeoRSS({read:function(b){var d,e,f,g,h,j,k,l,m,n,o,p,q,r=this.getElementsByTagNameNS(b,"*","item"),s=[],t=i.attributes,u=new OpenLayers.Projection("EPSG:4326"),v=c.map.getProjectionObject();for(f=0,g=r.length;f!==g;f+=1){d=r[f],e=a(d),q=this.createFeatureFromItem(d),m=new OpenLayers.Feature.Vector,o=q.geometry.components[0],"OpenLayers.Geometry.Polygon"===q.geometry.CLASS_NAME&&5===o.components.length?(h=V(o.components[1].x,o.components[1].y,o.components[3].x,o.components[3].y),j=new OpenLayers.Geometry.LinearRing(h),k=new OpenLayers.Geometry.Polygon(j),l=k.transform(u,v),m.geometry=l):m.geometry=this.parseFeature(d).geometry.transform(u,v),n={};for(p in t)t.hasOwnProperty(p)&&(n[t[p]]=e.find(p).text());m.attributes=n,s.push(m)}return s}})}),eventListeners:{featuresadded:function(a){J(c,p,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[m]&&K(c)},loadstart:function(){c.overlaysLoading[m]=!0,setTimeout(function(){c.overlaysLoading[m]&&K(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,p,n,f.id,i.tab),f.visibility=n):"json"===k?(f=new OpenLayers.Layer.Vector(m,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.Script({url:o,params:i.params,format:new OpenLayers.Format.GeoJSON({internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(a){var b,d,e,f,g,h,j,k,l,m,n,o=i.root,p=a[o]?a[o]:a,q=[],r=i.attributes,s=new OpenLayers.Projection("EPSG:4326"),t=c.map.getProjectionObject();for(d=0,e=p.length;d!==e;d+=1){b=p[d],f=new OpenLayers.Feature.Vector,n=b.geometry.coordinates[0],"Polygon"===b.geometry.type&&5===n.length?(j=V(n[1][0],n[1][1],n[3][0],n[3][1]),k=new OpenLayers.Geometry.LinearRing(j),l=new OpenLayers.Geometry.Polygon(k),m=l.transform(s,t),f.geometry=m):f.geometry=this.parseGeometry(b.geometry),g={};for(h in r)r.hasOwnProperty(h)&&(g[r[h]]=b[h]);f.attributes=g,f.geometry&&q.push(f)}return q}})}),eventListeners:{featuresadded:function(a){J(c,p,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[m]&&K(c)},loadstart:function(){c.overlaysLoading[m]=!0,setTimeout(function(){c.overlaysLoading[m]&&K(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,p,n,f.id,i.tab),f.visibility=n):"geojson"===k&&(f=new OpenLayers.Layer.Vector(m,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.Script({url:o,params:i.params,format:new OpenLayers.Format.GeoJSON({internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(a){var b,d,e,f,g,h,j,k,l,m,n,o=a.features,p=[],q=i.attributes,r=new OpenLayers.Projection("EPSG:4326"),s=c.map.getProjectionObject();for(b=0,d=o.length;b!==d;b+=1){e=o[b],f=new OpenLayers.Feature.Vector,n=e.geometry.coordinates[0],"Polygon"===e.geometry.type&&5===n.length?(j=V(n[1][0],n[1][1],n[3][0],n[3][1]),l=new OpenLayers.Geometry.LinearRing(j),k=new OpenLayers.Geometry.Polygon(l),m=k.transform(r,s),f.geometry=m):f.geometry=this.parseGeometry(e.geometry),g={};for(h in q)q.hasOwnProperty(h)&&(g[q[h]]=e.properties[h]);f.attributes=g,f.geometry&&p.push(f)}return p}})}),eventListeners:{featuresadded:function(a){J(c,p,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[m]&&K(c)},loadstart:function(){c.overlaysLoading[m]=!0,setTimeout(function(){c.overlaysLoading[m]&&K(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,p,n,f.id,i.tab),f.visibility=n)}))},T=function(b,d,e,f){var g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,C,D,E,F,H,I,J,K,L,M="<th>"+h.zoomFeature+"</th>",N="<th>"+h.select+"</th>",O=new OpenLayers.Format.WKT({internalProjection:f,externalProjection:e}),P=/<\/?[^>]+>/gi,Q=/\W/g;for(K=d.tables.length-1;-1!==K;K-=1){for(k=c.getElementById(d.tables[K].id),j=a(k),j.wrap("<div class='wb-geomap-table-wrapper'></div>"),i=j.parents(".wb-geomap-table-wrapper"),l=d.tables[K],m=[],o=new OpenLayers.Layer.Vector(j.find("caption").text(),{styleMap:G(l)}),p=k.getElementsByTagName("th"),r=k.getElementsByTagName("tr"),s=r.length,t=d.useMapControls,L=d.tables[K].visible===!1?!1:!0,q=p.length-1;-1!==q;q-=1)m[q]=p[q].innerHTML.replace(P,"");for(n=j.find("thead tr"),l.zoom&&t&&n.append(M),n.prepend(N),s=r.length-1;-1!==s;s-=1){for(u={},v=r[s],w=v.getAttribute("data-type"),y=v.getElementsByTagName("td"),z=y.length-1;-1!==z;z-=1)C=y[z],D=C.getElementsByTagName("script")[0],D&&D.parentNode.removeChild(D),u[m[z]]=C.innerHTML;if(null!==w){if("bbox"===w){for(E=v.getAttribute("data-geometry").split(","),H=V(E[0],E[1],E[2],E[3]),I="",J=H.length-1;-1!==J;J-=1)I+=H[J].x+" "+H[J].y+", ";I=I.slice(0,-2),F="POLYGON (("+I+"))"}else"wkt"===w&&(F=v.getAttribute("data-geometry"));x=O.read(F),v.setAttribute("id",x.id.replace(Q,"_")),x.attributes=u,o.addFeatures([x])}}o.id="#"+l.id,o.datatable=l.datatable,o.popupsInfo=l.popupsInfo,o.popups=l.popups,o.name=l.id,b.map.addLayer(o),b.queryLayers.push(o),o.visibility=L,l.tab?A(b,j,L,o.id,l.tab):b.glegend&&B(b,j,L,o.id),g=a("#msg_"+l.id),0===g.length&&i.after("<div id='msg_"+l.id+"'><p>"+h.hiddenLayer+"</p></div>"),L?a("#msg_"+l.id).fadeOut():a("#msg_"+l.id).fadeIn(),L?i.fadeIn():i.fadeOut()}},U=function(a,b){var c,d,e,f,g,i,j,k,l,m,n,o,p,q=a.gmap,r=a.map,t=h.mouseposition,x=h.scaleline,y=b.useMapControls,z=b.tables,A=z.length,B=a.queryLayers,C=B.length;for(a.selectControl=new OpenLayers.Control.SelectFeature(a.queryLayers,{onSelect:u,onUnselect:v,clickFeature:w}),r.addControl(a.selectControl),a.selectControl.activate(),l=0;l!==A;l+=1)for(e=z[l],f="#"+e.id,k=e.zoom,m=0;m!==C;m+=1)if(g=B[m],g.id===f)for(i=g.features,j=i.length,n=0;n!==j;n+=1)L(a,i[n],k,y);y&&(b.useMousePosition&&(r.addControl(new OpenLayers.Control.MousePosition),c=r.getControlsByClass("OpenLayers.Control.MousePosition")[0].div,c.setAttribute("aria-label",t),c.setAttribute("title",t)),b.useScaleLine&&(r.addControl(new OpenLayers.Control.ScaleLine),d=r.getControlsByClass("OpenLayers.Control.ScaleLine")[0].div,d.setAttribute("aria-label",x),d.setAttribute("title",x)),r.addControl(new OpenLayers.Control.KeyboardDefaults({autoActivate:!1})),q.attr({tabindex:"0","data-map":a.mapid}),s(a),q.before("<details id='geomap-details-"+a.mapid+"' class='wb-geomap-detail' style='width:"+(q.width()-10)+"px;'><summary>"+h.accessTitle+"</summary><p>"+h.access+"</p></details>")),(a.showAttribNRCan||b.attribution)&&(a.showAttribNRCan?r.baseLayer.attribution="<a href='"+h.attribLink+"'>©"+h.attribTitle+"</a>":b.attribution.href?r.baseLayer.attribution="<a href='"+b.attribution.href+"'>"+b.attribution.text+"</a>":r.baseLayer.attribution="<p>"+b.attribution.text+"</p>",r.addControl(new OpenLayers.Control.Attribution)),r.zoomLevel||r.center?(o=r.center?r.center.transform(new OpenLayers.Projection("EPSG:4326"),r.getProjectionObject()):new OpenLayers.LonLat([0,0]),p=r.zoomLevel?r.zoomLevel:5,r.setCenter(o,p)):r.zoomToMaxExtent()},V=function(a,b,c,d){var e,f=parseFloat(a),g=parseFloat(b),h=parseFloat(c),i=parseFloat(d),j=[];if(0===f.length||0===g.length||0===h.length||0===i.length)return!1;for(-180===f&&(f+=.1),180===h&&(h=-5),90===i&&(i-=3),-90===g&&(g=35),e=f;h>e;e+=.5)j.push(new OpenLayers.Geometry.Point(e,g));for(j.push(new OpenLayers.Geometry.Point(h,g)),e=h;e>f;e-=.5)j.push(new OpenLayers.Geometry.Point(e,i));return j.push(new OpenLayers.Geometry.Point(f,i)),j.push(new OpenLayers.Geometry.Point(f,g)),j},W=function(a,b){Q(a,b),a.locStyle=new OpenLayers.Style({pointRadius:10,strokeColor:"#ff0000",fillColor:"#333333"}),a.locLayer=new OpenLayers.Layer.Vector("Location Features",{styleMap:new OpenLayers.StyleMap({pointRadius:10,graphicName:"cross",strokeWidth:4,strokeOpacity:.6,strokeColor:"#FF0033",fillColor:"#FF0033",fillOpacity:0})}),a.map.addLayer(a.locLayer);var c=new OpenLayers.Projection("EPSG:4326"),d=a.map.getProjectionObject();y(a,b.useTab),T(a,b,c,d),S(a,b),U(a,b),b.useGeocoder&&aa(a),b.useAOI&&$(a),b.useGeolocation&&ba(a),a.gmap.attr({role:"dialog","aria-label":h.ariaMap}),a.map.events.register("mouseout",a.map,function(a){X(this,a)}),a.map.events.register("mouseover",a.map,function(a){X(this,a)})},X=function(b,c){var d,e=c.type,f=-1===c.currentTarget.className.indexOf("wb-geomap-map")?c.currentTarget.parentElement:c.currentTarget,g=b.getControlsByClass("OpenLayers.Control.KeyboardDefaults")[0];b&&(d=f.className.indexOf("active"),"mouseover"===e||"focusin"===e?d&&(g&&g.activate(),a(f).addClass("active")):d>0&&(g&&g.deactivate(),a(f).removeClass("active")))},Y=function(){var a,b,c={};for(b=n.length-1;-1!==b;b-=1)a=n[b],c[a.id]=a;return c},Z=function(a){var b,c;for(c=n.length-1;-1!==c;c-=1)if(b=n[c],b.id===a)return b},$=function(b){b.drawControl=new OpenLayers.Control.DrawFeature(b.locLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0},eventListeners:{featureadded:function(c){var d=new OpenLayers.Projection("EPSG:4326"),e=b.map.getProjectionObject(),f=c.feature.geometry.getBounds(),g=f.transform(e,d);a("#geomap-aoi-extent-"+b.mapid).val(f.toString()),a("#geomap-aoi-extent-lonlat-"+b.mapid).val(g.toString()),a("#geomap-aoi-minx-"+b.mapid).val(g.toArray()[0].toFixed(6)),a("#geomap-aoi-miny-"+b.mapid).val(g.toArray()[1].toFixed(6)),a("#geomap-aoi-maxx-"+b.mapid).val(g.toArray()[2].toFixed(6)),a("#geomap-aoi-maxy-"+b.mapid).val(g.toArray()[3].toFixed(6)),a("#geomap-aoi-btn-draw-"+b.mapid).click()}}}),b.map.addControl(b.drawControl),b.gmap.before("<div class='geomap-aoi panel panel-default'><div id='geomap-aoi-"+b.mapid+"' class='panel-body'></div></div>");var c,d,e,f,g,i,j=a("#geomap-map-"+b.mapid),l=a("#geomap-aoi-"+b.mapid);l.append("<fieldset id='form-aoi-"+b.mapid+"'><legend tabindex='-1'>"+h.aoiInstructions+"</legend><div class='row'><div class='col-md-2'><label for='geomap-aoi-maxy-"+b.mapid+"' class='wb-inv'>"+h.aoiNorth+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiNorth.charAt(0)+"</span><input type='number' id='geomap-aoi-maxy-"+b.mapid+"' placeholder='90' class='form-control input-sm' min='-90' max='90' step='0.000001'></input></div></div><div class='col-md-2'><label for='geomap-aoi-maxx-"+b.mapid+"' class='wb-inv'>"+h.aoiEast+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiEast.charAt(0)+"</span><input type='number' id='geomap-aoi-maxx-"+b.mapid+"' placeholder='180' class='form-control input-sm' min='-180' max='180' step='0.000001'></input> </div></div><div class='col-md-2'><label for='geomap-aoi-miny-"+b.mapid+"' class='wb-inv'>"+h.aoiSouth+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiSouth.charAt(0)+"</span><input type='number' id='geomap-aoi-miny-"+b.mapid+"' placeholder='-90' class='form-control input-sm' min='-90' max='90' step='0.000001'></input> </div></div><div class='col-md-2'><label for='geomap-aoi-minx-"+b.mapid+"' class='wb-inv'>"+h.aoiWest+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiWest.charAt(0)+"</span><input type='number' id='geomap-aoi-minx-"+b.mapid+"' placeholder='-180' class='form-control input-sm' min='-180' max='180' step='0.000001'></input> </div></div><div class='col-md-4'><button class='btn btn-default btn-sm' id='geomap-aoi-btn-draw-"+b.mapid+"'>"+h.add+"</button> <button class='btn btn-default btn-sm' id='geomap-aoi-btn-clear-"+b.mapid+"'>"+h.aoiBtnClear+"</button> </div></div><input type='hidden' id='geomap-aoi-extent-"+b.mapid+"'></input><input type='hidden' id='geomap-aoi-extent-lonlat-"+b.mapid+"'></input></fieldset></div><div class='clear'></div>"),b.aoiToggle?(l.parent().hide(),j.append("<button id='geomap-aoi-toggle-mode-draw-"+b.mapid+"' href='#' class='btn btn-sm geomap-geoloc-aoi-btn' title='"+h.aoiBtnDraw+"'><i class='glyphicon glyphicon-edit'></i><span class='wb-inv'> "+h.aoiBtnDraw+"</span></button>")):a("#geomap-aoi-btn-clear-"+b.mapid).after("<button id='geomap-aoi-toggle-mode-draw-"+b.mapid+"' href='#' class='btn btn-sm geomap-geoloc-aoi-btn' title='"+h.aoiBtnDraw+"'><i class='glyphicon glyphicon-edit'></i> "+h.aoiBtnDraw+"</button>"),k.on("click","#geomap-aoi-toggle-mode-draw-"+b.mapid,function(c){c.preventDefault();var d=b.map.getControlsByClass("OpenLayers.Control.DrawFeature")[0],e=d.active,f=a("#geomap-aoi-"+b.mapid);b.aoiToggle&&f.parent().slideToggle(function(){b.map.events.element.offsets=null,b.map.events.clearMouseCache()}),a(this).toggleClass("active"),e||f.find("legend").trigger("setfocus.wb"),e?d.deactivate():d.activate()}),k.on("click","#geomap-aoi-btn-clear-"+b.mapid,function(c){c.preventDefault(),a("#geomap-aoi-extent-"+b.mapid).val(""),a("#geomap-aoi-extent-lonlat-"+b.mapid).val(""),a("#geomap-aoi-minx-"+b.mapid).val("").parent().removeClass("has-error"),a("#geomap-aoi-miny-"+b.mapid).val("").parent().removeClass("has-error"),a("#geomap-aoi-maxx-"+b.mapid).val("").parent().removeClass("has-error"),a("#geomap-aoi-maxy-"+b.mapid).val("").parent().removeClass("has-error"),b.locLayer.removeAllFeatures()}),k.on("click","#geomap-aoi-btn-draw-"+b.mapid,function(c){c.preventDefault(),a("#geomap-aoi-extent-"+b.mapid).val(""),a("#geomap-aoi-extent-lonlat-"+b.mapid).val(""),a("#geomap-aoi-minx-"+b.mapid).parent().removeClass("has-error"),a("#geomap-aoi-maxx-"+b.mapid).parent().removeClass("has-error"),a("#geomap-aoi-maxy-"+b.mapid).parent().removeClass("has-error"),
a("#geomap-aoi-miny-"+b.mapid).parent().removeClass("has-error"),b.locLayer.removeAllFeatures();var d,e,f=parseFloat(a("#geomap-aoi-minx-"+b.mapid).val()),g=parseFloat(a("#geomap-aoi-miny-"+b.mapid).val()),h=parseFloat(a("#geomap-aoi-maxx-"+b.mapid).val()),i=parseFloat(a("#geomap-aoi-maxy-"+b.mapid).val()),j=!0;return(!f||-180>f||f>180)&&(a("#geomap-aoi-minx-"+b.mapid).parent().addClass("has-error"),j=!1),(!h||-180>h||h>180)&&(a("#geomap-aoi-maxx-"+b.mapid).parent().addClass("has-error"),j=!1),(!i||-90>i||i>90)&&(a("#geomap-aoi-maxy-"+b.mapid).parent().addClass("has-error"),j=!1),(!g||-90>g||g>90)&&(a("#geomap-aoi-miny-"+b.mapid).parent().addClass("has-error"),j=!1),j===!1?!1:(e={minx:f,miny:g,maxx:h,maxy:i},d=_(b,e),b.map.zoomToExtent(b.locLayer.getDataExtent()),a("#geomap-aoi-extent-"+b.mapid).val(d.getBounds().toBBOX()).trigger("change"),void a("#geomap-aoi-extent-lonlat-"+b.mapid).val(f+", "+g+", "+h+", "+i).trigger("change"))}),b.aoiExtent&&(c=b.aoiExtent.split(","),d=c[0].trim(),e=c[1].trim(),f=c[2].trim(),g=c[3].trim(),i=_(b,{minx:d,miny:e,maxx:f,maxy:g}),b.map.zoomToExtent(b.locLayer.getDataExtent()),a("#geomap-aoi-minx-"+b.mapid).val(d),a("#geomap-aoi-maxx-"+b.mapid).val(f),a("#geomap-aoi-maxy-"+b.mapid).val(g),a("#geomap-aoi-miny-"+b.mapid).val(e),a("#geomap-aoi-extent-"+b.mapid).val(i.getBounds().toBBOX()),a("#geomap-aoi-extent-lonlat-"+b.mapid).val(d+", "+e+", "+f+", "+g))},_=function(a,b){var c,d,e,f,g,h,i;return c=V(b.minx,b.miny,b.maxx,b.maxy),d=new OpenLayers.Geometry.LinearRing(c),e=new OpenLayers.Geometry.Polygon(d),f=new OpenLayers.Projection("EPSG:4326"),g=a.map.getProjectionObject(),h=e.transform(f,g),i=new OpenLayers.Feature.Vector(h),a.locLayer.addFeatures([i]),h},aa=function(b){var c,d,e=a("#geomap-map-"+b.mapid);e.append("<div class='geomap-geoloc'><label for='wb-geomap-geocode-search-"+b.mapid+"' class='wb-inv'>"+h.geoCoderLabel+"</label><input type='text' class='form-control input-sm opct-90' name='wb-geomap-geocode-search-"+b.mapid+"' id='wb-geomap-geocode-search-"+b.mapid+"' list='wb-geomap-geocode-results-"+b.mapid+"' autocomplete='off' placeholder='"+h.geoCoderPlaceholder+"' /><datalist id='wb-geomap-geocode-results-"+b.mapid+"'></datalist></div>"),a("#wb-geomap-geocode-search-"+b.mapid).trigger("wb-init.wb-datalist"),k.on("keypress","#wb-geomap-geocode-search-"+b.mapid,function(c){if(13===c.keyCode){var d,e,f,g,h,i,j,k,l,m,n,o,p,q=new OpenLayers.Projection("EPSG:4326"),r=b.map.getProjectionObject();if(b.locLayer.destroyFeatures(),o=a("#wb-geomap-geocode-search-"+b.mapid).val(),!o)return a("#wb-geomap-geocode-search-"+b.mapid).parent().addClass("has-error"),void setTimeout(function(){a("#wb-geomap-geocode-search-"+b.mapid).parent().removeClass("has-error")},5e3);d=a("#wb-geomap-geocode-results-"+b.mapid+" option").filter(function(){return this.value===o}).data("bbox"),l=a("#wb-geomap-geocode-results-"+b.mapid+" option").filter(function(){return this.value===o}).data("lat-lon"),f={bbox:d,lonlat:l},null!==f.bbox?(e=new OpenLayers.Bounds.fromString(f.bbox),g=V(e.left,e.bottom,e.right,e.top),n=new OpenLayers.Geometry.LinearRing(g),i=new OpenLayers.Geometry.Polygon(n),j=i.transform(q,r),h=new OpenLayers.Feature.Vector(j),b.locLayer.addFeatures([h]),b.map.zoomToExtent(j.getBounds())):null!==f.lonlat&&(p=0===b.map.getZoom()?.85*b.map.numZoomLevels:b.map.getZoom(),k=new OpenLayers.LonLat(f.lonlat.split(",")).transform(q,r),m=new OpenLayers.Geometry.Point(k.lon,k.lat),h=new OpenLayers.Feature.Vector(m),b.locLayer.addFeatures([h]),b.map.setCenter(k,p))}}),k.on("keyup","#wb-geomap-geocode-search-"+b.mapid,function(e){var f,g,i,j,k,l=a("#wb-geomap-geocode-results-"+b.mapid),m=[];a(this).parent().removeClass("has-error"),f=a(this).val().trim(),k=e.which,""===f||f.length<=2||13===k||9===k||40===k||39===k||38===k||(c&&c.abort(),clearTimeout(d),d=setTimeout(function(){c=a.get(h.geoLocationURL,{q:f+"*"},function(c){if(m="<!--[if lte IE 9]><select><![endif]-->",c.length)for(var d=0,e=c.length;e>d;d++)j=c[d].title.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),g=c[d].bbox?c[d].bbox[0]+", "+c[d].bbox[1]+", "+c[d].bbox[2]+", "+c[d].bbox[3]:null,i=c[d].geometry&&"Point"===c[d].geometry.type?c[d].geometry.coordinates[0]+", "+c[d].geometry.coordinates[1]:null,m+="<option value='"+j+"' data-lat-lon='"+i+"' data-bbox='"+g+"' data-type='"+c[d].type+"'></option>",d===e-1&&(m+="<!--[if lte IE 9]></select><![endif]-->",l.html(m));a(".geomap-geoloc .wb-al-cnt").length>0&&(a("#wb-geomap-geocode-search-"+b.mapid).removeClass("wb-datalist-inited"),a("#wb-geomap-geocode-results-"+b.mapid).remove(),a("#wb-al-wb-geomap-geocode-search-"+b.mapid).remove(),a("#wb-al-wb-geomap-geocode-search-"+b.mapid+"-src").remove(),a("#wb-geomap-geocode-search-"+b.mapid).after(l),a("#wb-geomap-geocode-search-"+b.mapid).trigger("wb-init.wb-datalist"))},"jsonp")},500))})},ba=function(b){a("body").append("<section id='overlay-location-error' class='wb-overlay modal-content overlay-def wb-bar-t bg-danger'><header><h2 class='modal-title'>Geolocation error.</h2></header></section>"),a("#overlay-location-error").trigger("wb-init.wb-overlay");var d=new OpenLayers.Control.Button({title:h.geolocBtn,displayClass:"olButtonGeolocate",eventListeners:{activate:function(){b.geoLocLayer.removeAllFeatures(),b.geolocate.deactivate(),b.geolocate.watch=!0,b.geolocate.activate()},deactivate:function(){b.geoLocLayer.removeAllFeatures(),b.geolocate.deactivate(),b.geolocate.watch=!1}},type:OpenLayers.Control.TYPE_TOGGLE}),e=new OpenLayers.Control.Panel({displayClass:"olPanelGeolocate",createControlMarkup:function(){return c.createElement("button")}});e.addControls([d]),b.geoLocLayer=new OpenLayers.Layer.Vector("geoLocLayer"),b.geolocate=new OpenLayers.Control.Geolocate({type:OpenLayers.Control.TYPE_TOGGLE,bind:!0,watch:!0,geolocationOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:7e3},eventListeners:{locationupdated:function(a){b.geoLocLayer.removeAllFeatures();var c=new OpenLayers.Feature.Vector(a.point,null,{graphicName:"circle",fillColor:"#FF0033",strokeWidth:0,pointRadius:5}),d=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,40,0),null,{fillOpacity:.3,fillColor:"#FF0033",strokeWidth:0});b.geoLocLayer.addFeatures([c,d]),b.map.zoomToExtent(b.geoLocLayer.getDataExtent()),ca(d,b.geoLocLayer)},locationuncapable:function(){a("#overlay-location-error h2.modal-title").text(h.geolocUncapable),a("#overlay-location-error").trigger("open.wb-overlay")},locationfailed:function(){a("#overlay-location-error h2.modal-title").text(h.geolocFailed),a("#overlay-location-error").trigger("open.wb-overlay")}}}),b.map.addLayers([b.geoLocLayer]),b.map.addControls([e,b.geolocate])},ca=function(a,c){var d=a.geometry.getCentroid(),e=a.geometry.getBounds(),f=Math.abs((e.right-e.left)/2),g=0,h="up",i=function(){g>16&&clearInterval(b.resizeInterval);var e=.03*f,i=e/f;switch(g){case 4:case 12:h="down";break;case 8:h="up"}"up"!==h&&(i=-Math.abs(i)),a.geometry.resize(1+i,d),c.drawFeature(a),g++};b.resizeInterval=b.setInterval(i,50,d,f)},da=function(b){var c,e,f=b.glayers,g=b.map,h=g.layers;f.find(".wb-tables").trigger("wb-init.wb-tables"),f.find(".wb-geomap-tabs").trigger("wb-init.wb-tabs"),C(b),b.map.id=b.mapid,n.push(g),setTimeout(function(){b.gmap.find("img").attr("alt",""),a(".olTileImage").attr("alt",""),d.ready(a("#"+b.mapid),i,[g])},2e3),b.map.events.on({moveend:function(){for(a(".olTileImage").attr("alt",""),a(b.mapid).trigger("wb-updated"+j,[g]),e=h.length-1;-1!==e;e-=1)c=h[e],"OpenLayers.Layer.WMS"===c.CLASS_NAME&&c.redraw(!0)}}),n.length===a(j).length&&d.doc.trigger("geomap.ready",[Y()])},ea=function(a){var b,c=Z(a.getAttribute("data-map"));return a.getAttribute("data-layer")?(b=c.getLayer(a.getAttribute("data-layer")),[c,b,"OpenLayers.Layer.Vector"===b.CLASS_NAME?b.getFeatureById(a.getAttribute("data-feature")):null]):[c,null,null]};k.on("geomap.wb",j,q),k.on("click",".geomap-zoomto",function(b){var c,d,e=b.which,f=b.target;e&&1!==e||(b.preventDefault(),c=f.getAttribute("data-map"),d=ea(f),d[0].zoomToExtent(d[2].geometry.bounds),a("#"+c+" .wb-geomap-map").trigger("setfocus.wb"))}),k.on(d.resizeEvents,function(){if(0!==n.length){var b,c,d,e=Y();for(b in e)e.hasOwnProperty(b)&&(c=e[b],d=a(c.div),d.height(.8*d.width()),c.updateSize(),c.zoomToMaxExtent())}}),k.on("change",".geomap-cbx",function(a){var b=a.target,c=ea(b)[2];b.checked?w(c):f.selectControl.unselect(c)}),k.on("change",".geomap-lgnd-cbx",function(b){var d=b.target,e=ea(d)[1],f=d.value,g=c.getElementById("cb_"+f).checked,i=a("table#"+f),j=i.parents(".wb-geomap-table-wrapper"),k=a("#msg_"+f);e.setVisibility(g),a("#sb_"+e.name).toggle(g),0!==k.length?g?k.fadeOut():k.fadeIn():j.after("<div id='msg_"+f+"'><p>"+h.hiddenLayer+"</p></div>"),g?j.fadeIn():j.fadeOut()}),k.on("focusin focusout",".wb-geomap-map",function(a){var b=a.currentTarget,c=Z(b.getAttribute("data-map"));X(c,a)}),k.on("keydown click",".olPopupCloseBox span",function(a){var b=a.which,c=a.currentTarget;"keydown"===a.type?13===b&&ea(c)[2].popup.hide():b&&1!==b||Z(c.getAttribute("data-map")).getControlsByClass("OpenLayers.Control.SelectFeature")[0].unselect(e)})}(jQuery,window,document,wb);